<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advisor Pro - Trading Autom√°tico Gr√°tis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.0.2/dist/browser.js"></script>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg-dark); color: var(--text-primary); padding-bottom: 50px; }

        header { 
            background: var(--bg-card); 
            padding: 1rem 2rem; 
            border-bottom: 1px solid #334155; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .connection-status { 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .status-dot.connected { background: var(--success); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 1rem; display: grid; grid-template-columns: 1fr; gap: 1rem; }

        .card { 
            background: var(--bg-card); 
            border-radius: 12px; 
            padding: 1.5rem; 
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .card-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .card-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }

        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); }
        
        input, select { 
            width: 100%; 
            background: #0f172a; 
            border: 1px solid #334155; 
            color: white; 
            padding: 0.75rem; 
            border-radius: 6px; 
            font-size: 0.95rem;
        }

        input:focus, select:focus { outline: 2px solid var(--accent); border-color: transparent; }

        button { 
            background: var(--accent); 
            color: white; 
            border: none; 
            padding: 0.75rem 1.5rem; 
            border-radius: 6px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.2s;
        }

        button:hover { background: #2563eb; transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        
        button.success { background: var(--success); }
        button.success:hover { background: #059669; }
        
        button.danger { background: var(--danger); }
        button.danger:hover { background: #dc2626; }

        button.warning { background: var(--warning); color: #000; }
        button.warning:hover { background: #d97706; }

        .price-display {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            background: #0f172a;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .price-up { color: var(--success); }
        .price-down { color: var(--danger); }

        .signal-box {
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin: 1rem 0;
            border: 2px solid;
        }

        .signal-buy { 
            background: rgba(16, 185, 129, 0.1); 
            border-color: var(--success);
            color: var(--success);
        }

        .signal-sell { 
            background: rgba(239, 68, 68, 0.1); 
            border-color: var(--danger);
            color: var(--danger);
        }

        .signal-neutral { 
            background: rgba(148, 163, 184, 0.1); 
            border-color: var(--text-secondary);
            color: var(--text-secondary);
        }

        .signal-strength {
            font-size: 0.9rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .indicator-item {
            background: #0f172a;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .indicator-name { font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .indicator-value { font-size: 1.2rem; font-weight: 600; }

        .alert-item {
            background: #0f172a;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--accent);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-time { font-size: 0.8rem; color: var(--text-secondary); }
        .alert-message { font-weight: 500; margin: 0.25rem 0; }

        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        th { 
            text-align: left; 
            color: var(--text-secondary); 
            font-size: 0.8rem; 
            padding: 0.75rem; 
            border-bottom: 2px solid #334155;
            position: sticky;
            top: 0;
            background: var(--bg-card);
        }
        td { padding: 0.75rem; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        
        .badge { 
            padding: 0.25rem 0.75rem; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            font-weight: 600;
            display: inline-block;
        }
        
        .badge-buy { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge-sell { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge-neutral { background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .stat-card {
            background: #0f172a;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value { font-size: 2rem; font-weight: 700; display: block; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.9rem; color: var(--text-secondary); }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 1rem 0;
        }

        .backtest-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--accent);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            z-index: 1000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .price-display { font-size: 1.5rem; }
        }
    </style>
</head>
<body>

<header>
    <div>
        <h1>ü§ñ Advisor Pro</h1>
        <span style="font-size: 0.8rem; color: var(--text-secondary);">An√°lise Autom√°tica em Tempo-Real</span>
    </div>
    <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Desconectado</span>
    </div>
</header>

<div class="container">

    <!-- Configura√ß√£o -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">‚öôÔ∏è Configura√ß√£o</span>
        </div>
        <div class="grid-3">
            <div class="form-group">
                <label>Ativo</label>
                <select id="assetSelect" onchange="changeAsset()">
                    <option value="BTCUSDT">Bitcoin (BTC/USDT)</option>
                    <option value="ETHUSDT">Ethereum (ETH/USDT)</option>
                    <option value="BNBUSDT">Binance Coin (BNB/USDT)</option>
                    <option value="SOLUSDT">Solana (SOL/USDT)</option>
                    <option value="XRPUSDT">Ripple (XRP/USDT)</option>
                </select>
            </div>
            <div class="form-group">
                <label>Timeframe</label>
                <select id="timeframe" onchange="changeTimeframe()">
                    <option value="1m">1 minuto</option>
                    <option value="5m">5 minutos</option>
                    <option value="15m" selected>15 minutos</option>
                    <option value="1h">1 hora</option>
                    <option value="4h">4 horas</option>
                    <option value="1d">1 dia</option>
                </select>
            </div>
            <div class="form-group">
                <label>Capital (‚Ç¨)</label>
                <input type="number" id="capital" value="10000" onchange="saveSettings()">
            </div>
            <div class="form-group">
                <label>Risco por Trade (%)</label>
                <input type="number" id="riskPercent" value="1" step="0.1" onchange="saveSettings()">
            </div>
            <div class="form-group">
                <label>RSI Per√≠odo</label>
                <input type="number" id="rsiPeriod" value="14" onchange="saveSettings()">
            </div>
            <div class="form-group">
                <label>Notifica√ß√µes</label>
                <select id="notifications" onchange="saveSettings()">
                    <option value="all">Todos os sinais</option>
                    <option value="strong">Apenas sinais fortes</option>
                    <option value="none">Desativadas</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Pre√ßo e Sinal -->
    <div class="grid-2">
        <div class="card">
            <div class="card-header">
                <span class="card-title">üìä Pre√ßo em Tempo-Real</span>
                <span id="assetName" class="badge badge-neutral">BTCUSDT</span>
            </div>
            <div class="price-display" id="currentPrice">
                ---
            </div>
            <div class="indicator-grid" id="indicatorsGrid">
                <div class="indicator-item">
                    <div class="indicator-name">RSI (14)</div>
                    <div class="indicator-value" id="rsiValue">--</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-name">MACD</div>
                    <div class="indicator-value" id="macdValue">--</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-name">EMA 20</div>
                    <div class="indicator-value" id="ema20Value">--</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-name">EMA 50</div>
                    <div class="indicator-value" id="ema50Value">--</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">üéØ Sinal Atual</span>
            </div>
            <div id="signalBox" class="signal-box signal-neutral">
                <div style="font-size: 1.5rem; font-weight: 700;" id="signalText">AGUARDAR</div>
                <div class="signal-strength" id="signalStrength">For√ßa: --</div>
                <div style="margin-top: 1rem; font-size: 0.9rem;" id="signalReason">
                    A analisar mercado...
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                <div class="stat-card">
                    <span class="stat-label">Stop Loss Sugerido</span>
                    <span class="stat-value text-danger" id="suggestedStop">--</span>
                </div>
                <div class="stat-card">
                    <span class="stat-label">Take Profit Sugerido</span>
                    <span class="stat-value text-success" id="suggestedTP">--</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Gr√°fico -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üìà Gr√°fico & Indicadores</span>
            <button onclick="toggleChartType()" class="warning" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                Alternar Tipo
            </button>
        </div>
        <div class="chart-container">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <!-- Alertas -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üîî Alertas Recentes</span>
            <button onclick="clearAlerts()" class="danger" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                Limpar
            </button>
        </div>
        <div id="alertsContainer">
            <div style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                Sem alertas recentes
            </div>
        </div>
    </div>

    <!-- Backtesting -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üìä Backtesting da Estrat√©gia</span>
        </div>
        <div class="backtest-controls">
            <select id="backtestDays">
                <option value="7">7 dias</option>
                <option value="30" selected>30 dias</option>
                <option value="90">90 dias</option>
            </select>
            <button onclick="runBacktest()" class="success">
                Executar Backtest
            </button>
            <button onclick="exportBacktest()" class="warning">
                Exportar Resultados
            </button>
        </div>
        <div id="backtestResults" style="display: none;">
            <div class="stats-grid" id="backtestStats">
                <!-- Preenchido via JS -->
            </div>
            <div class="chart-container">
                <canvas id="backtestChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Hist√≥rico de Trades -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">üìù Hist√≥rico de Sinais</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Data/Hora</th>
                    <th>Ativo</th>
                    <th>Sinal</th>
                    <th>Pre√ßo</th>
                    <th>RSI</th>
                    <th>For√ßa</th>
                    <th>Resultado</th>
                </tr>
            </thead>
            <tbody id="signalsTable">
                <!-- Preenchido via JS -->
            </tbody>
        </table>
    </div>

</div>

<script>
// --- Vari√°veis Globais ---
let ws = null;
let chart = null;
let backtestChart = null;
let currentSymbol = 'BTCUSDT';
let currentTimeframe = '15m';
let priceData = [];
let volumeData = [];
let alerts = [];
let signals = [];
let currentPrice = 0;
let previousPrice = 0;

// Configura√ß√µes
let settings = {
    capital: 10000,
    riskPercent: 1,
    rsiPeriod: 14,
    notifications: 'all'
};

// --- Inicializa√ß√£o ---
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    initChart();
    connectWebSocket();
    loadAlerts();
    loadSignals();
    
    // Pedir permiss√£o para notifica√ß√µes
    if ("Notification" in window && Notification.permission === "default") {
        Notification.requestPermission();
    }
});

// --- WebSocket Binance (Gr√°tis) ---
function connectWebSocket() {
    const streamName = `${currentSymbol.toLowerCase()}@kline_${currentTimeframe}`;
    ws = new WebSocket(`wss://stream.binance.com:9443/ws/${streamName}`);

    ws.onopen = () => {
        document.getElementById('statusDot').classList.add('connected');
        document.getElementById('statusText').textContent = 'Conectado - Tempo Real';
        addAlert('Conectado ao mercado em tempo-real', 'info');
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        const kline = data.k;
        
        previousPrice = currentPrice;
        currentPrice = parseFloat(kline.c);
        
        updatePriceDisplay(currentPrice);
        updateChartData(kline);
        calculateIndicators();
        generateSignal();
    };

    ws.onclose = () => {
        document.getElementById('statusDot').classList.remove('connected');
        document.getElementById('statusText').textContent = 'Desconectado';
        
        // Reconectar ap√≥s 3 segundos
        setTimeout(connectWebSocket, 3000);
    };

    ws.onerror = (error) => {
        console.error('WebSocket error:', error);
        addAlert('Erro na conex√£o WebSocket', 'error');
    };
}

// --- Carregar Dados Hist√≥ricos ---
async function loadHistoricalData() {
    try {
        const response = await fetch(
            `https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${currentTimeframe}&limit=100`
        );
        const data = await response.json();
        
        priceData = data.map(d => parseFloat(d[4])); // close price
        volumeData = data.map(d => parseFloat(d[5])); // volume
        
        updateChart();
        calculateIndicators();
    } catch (error) {
        console.error('Erro ao carregar dados hist√≥ricos:', error);
        addAlert('Erro ao carregar dados hist√≥ricos', 'error');
    }
}

// --- Atualizar Display de Pre√ßo ---
function updatePriceDisplay(price) {
    const priceEl = document.getElementById('currentPrice');
    priceEl.textContent = price.toFixed(2);
    
    if (price > previousPrice) {
        priceEl.className = 'price-display price-up';
    } else if (price < previousPrice) {
        priceEl.className = 'price-display price-down';
    }
}

// --- C√°lculo de Indicadores T√©cnicos ---
function calculateIndicators() {
    if (priceData.length < 50) return;

    // RSI
    const rsiInput = {
        values: priceData.slice(-settings.rsiPeriod - 1),
        period: settings.rsiPeriod
    };
    const rsi = technicalIndicators.RSI.calculate(rsiInput);
    const currentRSI = rsi[rsi.length - 1];
    
    // EMA
    const ema20Input = {
        values: priceData,
        period: 20
    };
    const ema20 = technicalIndicators.EMA.calculate(ema20Input);
    
    const ema50Input = {
        values: priceData,
        period: 50
    };
    const ema50 = technicalIndicators.EMA.calculate(ema50Input);

    // MACD
    const macdInput = {
        values: priceData,
        fastPeriod: 12,
        slowPeriod: 26,
        signalPeriod: 9
    };
    const macd = technicalIndicators.MACD.calculate(macdInput);
    const currentMACD = macd[macd.length - 1];

    // Atualizar display
    document.getElementById('rsiValue').textContent = currentRSI ? currentRSI.toFixed(2) : '--';
    document.getElementById('ema20Value').textContent = ema20[ema20.length - 1] ? ema20[ema20.length - 1].toFixed(2) : '--';
    document.getElementById('ema50Value').textContent = ema50[ema50.length - 1] ? ema50[ema50.length - 1].toFixed(2) : '--';
    document.getElementById('macdValue').textContent = currentMACD ? (currentMACD.MACD > 0 ? '+' : '') + currentMACD.MACD.toFixed(2) : '--';

    // Colorir RSI
    const rsiEl = document.getElementById('rsiValue');
    if (currentRSI > 70) rsiEl.style.color = 'var(--danger)';
    else if (currentRSI < 30) rsiEl.style.color = 'var(--success)';
    else rsiEl.style.color = 'var(--text-primary)';

    return { rsi: currentRSI, ema20: ema20, ema50: ema50, macd: currentMACD };
}

// --- Gera√ß√£o de Sinais ---
function generateSignal() {
    const indicators = calculateIndicators();
    if (!indicators) return;

    const { rsi, ema20, ema50, macd } = indicators;
    const currentEMA20 = ema20[ema20.length - 1];
    const currentEMA50 = ema50[ema50.length - 1];
    
    let signal = 'NEUTRAL';
    let strength = 0;
    let reasons = [];

    // An√°lise RSI
    if (rsi < 30) {
        signal = 'COMPRA';
        strength += 1;
        reasons.push('RSI em sobrevenda (<30)');
    } else if (rsi > 70) {
        signal = 'VENDA';
        strength += 1;
        reasons.push('RSI em sobrecompra (>70)');
    }

    // An√°lise Cruzamento EMAs
    if (currentEMA20 > currentEMA50) {
        if (signal === 'COMPRA') strength += 1;
        else if (signal === 'NEUTRAL') {
            signal = 'COMPRA';
            strength = 1;
        }
        reasons.push('EMA20 acima da EMA50 (tend√™ncia alta)');
    } else {
        if (signal === 'VENDA') strength += 1;
        else if (signal === 'NEUTRAL') {
            signal = 'VENDA';
            strength = 1;
        }
        reasons.push('EMA20 abaixo da EMA50 (tend√™ncia baixa)');
    }

    // An√°lise MACD
    if (macd && macd.MACD > macd.signal) {
        if (signal === 'COMPRA') strength += 1;
        reasons.push('MACD positivo');
    } else if (macd && macd.MACD < macd.signal) {
        if (signal === 'VENDA') strength += 1;
        reasons.push('MACD negativo');
    }

    // Pre√ßo vs EMA
    if (currentPrice > currentEMA20) {
        reasons.push('Pre√ßo acima da EMA20');
    } else {
        reasons.push('Pre√ßo abaixo da EMA20');
    }

    // Determinar for√ßa do sinal
    let signalClass = 'signal-neutral';
    let signalText = 'AGUARDAR';
    
    if (strength >= 3) {
        signalClass = signal === 'COMPRA' ? 'signal-buy' : 'signal-sell';
        signalText = signal === 'COMPRA' ? 'üü¢ COMPRAR' : 'üî¥ VENDER';
        
        // Enviar notifica√ß√£o
        if (settings.notifications === 'all' || (settings.notifications === 'strong' && strength >= 3)) {
            sendNotification(signalText, `${currentSymbol} - ${reasons.join(', ')}`);
            addAlert(`Sinal ${signal}: ${reasons.join(', ')}`, signal === 'COMPRA' ? 'buy' : 'sell');
            
            // Guardar sinal
            signals.unshift({
                date: new Date().toLocaleString(),
                asset: currentSymbol,
                signal: signal,
                price: currentPrice,
                rsi: rsi.toFixed(2),
                strength: strength,
                result: 'Pendente'
            });
            saveSignals();
            updateSignalsTable();
        }
    }

    // Atualizar UI
    const signalBox = document.getElementById('signalBox');
    signalBox.className = `signal-box ${signalClass}`;
    document.getElementById('signalText').textContent = signalText;
    document.getElementById('signalStrength').textContent = `For√ßa: ${strength}/4`;
    document.getElementById('signalReason').textContent = reasons.join(' ‚Ä¢ ');

    // Calcular Stop Loss e Take Profit
    calculateStopLossTakeProfit(signal, strength);
}

function calculateStopLossTakeProfit(signal, strength) {
    const atr = currentPrice * 0.02; // ATR simplificado (2%)
    let stopLoss, takeProfit;

    if (signal === 'COMPRA') {
        stopLoss = currentPrice - (atr * (4 - strength));
        takeProfit = currentPrice + (atr * (4 - strength) * 2);
    } else if (signal === 'VENDA') {
        stopLoss = currentPrice + (atr * (4 - strength));
        takeProfit = currentPrice - (atr * (4 - strength) * 2);
    } else {
        stopLoss = currentPrice;
        takeProfit = currentPrice;
    }

    document.getElementById('suggestedStop').textContent = stopLoss.toFixed(2);
    document.getElementById('suggestedTP').textContent = takeProfit.toFixed(2);
}

// --- Gr√°fico Chart.js ---
function initChart() {
    const ctx = document.getElementById('mainChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Pre√ßo',
                     [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'EMA 20',
                     [],
                    borderColor: '#f59e0b',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'EMA 50',
                    data: [],
                    borderColor: '#ef4444',
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    labels: { color: '#94a3b8' }
                }
            },
            scales: {
                y: {
                    grid: { color: '#334155' },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });

    loadHistoricalData();
}

function updateChartData(kline) {
    const time = new Date(kline.t).toLocaleTimeString();
    
    if (priceData.length > 100) {
        priceData.shift();
        chart.data.labels.shift();
    }
    
    priceData.push(parseFloat(kline.c));
    chart.data.labels.push(time);
    chart.data.datasets[0].data = priceData;

    // Atualizar EMAs
    if (priceData.length >= 50) {
        const ema20Input = { values: priceData, period: 20 };
        const ema20 = technicalIndicators.EMA.calculate(ema20Input);
        chart.data.datasets[1].data = ema20.map(e => e);

        const ema50Input = { values: priceData, period: 50 };
        const ema50 = technicalIndicators.EMA.calculate(ema50Input);
        chart.data.datasets[2].data = ema50.map(e => e);
    }

    chart.update('none'); // atualiza√ß√£o suave
}

function updateChart() {
    const labels = priceData.map((_, i) => i);
    chart.data.labels = labels;
    chart.data.datasets[0].data = priceData;
    chart.update();
}

function toggleChartType() {
    const newType = chart.config.type === 'line' ? 'candlestick' : 'line';
    // Simplifica√ß√£o: apenas alterna entre line e bar
    chart.config.type = chart.config.type === 'line' ? 'bar' : 'line';
    chart.update();
}

// --- Notifica√ß√µes e Alertas ---
function sendNotification(title, body) {
    if ("Notification" in window && Notification.permission === "granted") {
        new Notification(title, {
            body: body,
            icon: 'https://bin.bnbstatic.com/image/admin_mgs_image_upload/20201110/87496e72-58f9-445d-b2b3-40b54e9c0e72.png'
        });
    }
}

function addAlert(message, type) {
    const alert = {
        time: new Date().toLocaleTimeString(),
        message: message,
        type: type
    };
    
    alerts.unshift(alert);
    if (alerts.length > 20) alerts.pop();
    
    saveAlerts();
    renderAlerts();
}

function renderAlerts() {
    const container = document.getElementById('alertsContainer');
    
    if (alerts.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">Sem alertas recentes</div>';
        return;
    }

    container.innerHTML = alerts.map(alert => {
        let borderColor = 'var(--accent)';
        if (alert.type === 'buy') borderColor = 'var(--success)';
        if (alert.type === 'sell') borderColor = 'var(--danger)';
        if (alert.type === 'error') borderColor = 'var(--danger)';

        return `
            <div class="alert-item" style="border-left-color: ${borderColor}">
                <div>
                    <div class="alert-time">${alert.time}</div>
                    <div class="alert-message">${alert.message}</div>
                </div>
            </div>
        `;
    }).join('');
}

function clearAlerts() {
    alerts = [];
    saveAlerts();
    renderAlerts();
}

function loadAlerts() {
    const saved = localStorage.getItem('tradingAlerts');
    if (saved) {
        alerts = JSON.parse(saved);
        renderAlerts();
    }
}

function saveAlerts() {
    localStorage.setItem('tradingAlerts', JSON.stringify(alerts));
}

function loadSignals() {
    const saved = localStorage.getItem('tradingSignals');
    if (saved) {
        signals = JSON.parse(saved);
        updateSignalsTable();
    }
}

function saveSignals() {
    localStorage.setItem('tradingSignals', JSON.stringify(signals));
}

function updateSignalsTable() {
    const tbody = document.getElementById('signalsTable');
    tbody.innerHTML = signals.slice(0, 50).map(sig => {
        let badgeClass = sig.signal === 'COMPRA' ? 'badge-buy' : sig.signal === 'VENDA' ? 'badge-sell' : 'badge-neutral';
        return `
            <tr>
                <td>${sig.date}</td>
                <td>${sig.asset}</td>
                <td><span class="badge ${badgeClass}">${sig.signal}</span></td>
                <td>${parseFloat(sig.price).toFixed(2)}</td>
                <td>${sig.rsi}</td>
                <td>${sig.strength}/4</td>
                <td>${sig.result}</td>
            </tr>
        `;
    }).join('');
}

// --- Backtesting ---
async function runBacktest() {
    const days = parseInt(document.getElementById('backtestDays').value);
    const results = {
        trades: [],
        wins: 0,
        losses: 0,
        totalReturn: 0,
        equity: [settings.capital]
    };

    addAlert(`Iniciando backtest de ${days} dias...`, 'info');

    try {
        // Buscar dados hist√≥ricos
        const endTime = Date.now();
        const startTime = endTime - (days * 24 * 60 * 60 * 1000);
        
        const response = await fetch(
            `https://api.binance.com/api/v3/klines?symbol=${currentSymbol}&interval=${currentTimeframe}&limit=1000`
        );
        const data = await response.json();

        let capital = settings.capital;
        let position = null;

        for (let i = 100; i < data.length; i++) {
            const slice = data.slice(i - 100, i);
            const closes = slice.map(d => parseFloat(d[4]));
            
            // Calcular indicadores
            const rsiInput = { values: closes.slice(-settings.rsiPeriod - 1), period: settings.rsiPeriod };
            const rsi = technicalIndicators.RSI.calculate(rsiInput);
            const currentRSI = rsi[rsi.length - 1];

            const ema20Input = { values: closes, period: 20 };
            const ema20 = technicalIndicators.EMA.calculate(ema20Input);
            const currentEMA20 = ema20[ema20.length - 1];

            const ema50Input = { values: closes, period: 50 };
            const ema50 = technicalIndicators.EMA.calculate(ema50Input);
            const currentEMA50 = ema50[ema50.length - 1];

            const currentPrice = closes[closes.length - 1];

            // L√≥gica de entrada
            if (!position && currentRSI < 30 && currentEMA20 > currentEMA50) {
                // Compra
                const riskAmount = capital * (settings.riskPercent / 100);
                const stopLoss = currentPrice * 0.98;
                const takeProfit = currentPrice * 1.04;
                
                position = {
                    type: 'BUY',
                    entryPrice: currentPrice,
                    stopLoss: stopLoss,
                    takeProfit: takeProfit,
                    amount: riskAmount / (currentPrice - stopLoss)
                };
            } else if (!position && currentRSI > 70 && currentEMA20 < currentEMA50) {
                // Venda
                const riskAmount = capital * (settings.riskPercent / 100);
                const stopLoss = currentPrice * 1.02;
                const takeProfit = currentPrice * 0.96;
                
                position = {
                    type: 'SELL',
                    entryPrice: currentPrice,
                    stopLoss: stopLoss,
                    takeProfit: takeProfit,
                    amount: riskAmount / (stopLoss - currentPrice)
                };
            }

            // Verificar sa√≠da
            if (position) {
                if (position.type === 'BUY') {
                    if (currentPrice <= position.stopLoss) {
                        // Stop loss
                        const loss = position.amount * (position.entryPrice - position.stopLoss);
                        capital -= loss;
                        results.losses++;
                        results.trades.push({ type: 'LOSS', pnl: -loss });
                        position = null;
                    } else if (currentPrice >= position.takeProfit) {
                        // Take profit
                        const profit = position.amount * (position.takeProfit - position.entryPrice);
                        capital += profit;
                        results.wins++;
                        results.trades.push({ type: 'WIN', pnl: profit });
                        position = null;
                    }
                } else if (position.type === 'SELL') {
                    if (currentPrice >= position.stopLoss) {
                        const loss = position.amount * (position.stopLoss - position.entryPrice);
                        capital -= loss;
                        results.losses++;
                        results.trades.push({ type: 'LOSS', pnl: -loss });
                        position = null;
                    } else if (currentPrice <= position.takeProfit) {
                        const profit = position.amount * (position.entryPrice - position.takeProfit);
                        capital += profit;
                        results.wins++;
                        results.trades.push({ type: 'WIN', pnl: profit });
                        position = null;
                    }
                }
            }

            results.equity.push(capital);
        }

        results.totalReturn = ((capital - settings.capital) / settings.capital * 100).toFixed(2);
        displayBacktestResults(results, days);

    } catch (error) {
        console.error('Erro no backtest:', error);
        addAlert('Erro ao executar backtest', 'error');
    }
}

function displayBacktestResults(results, days) {
    document.getElementById('backtestResults').style.display = 'block';
    
    const winRate = results.trades.length > 0 
        ? ((results.wins / results.trades.length) * 100).toFixed(1) 
        : 0;

    const statsHTML = `
        <div class="stat-card">
            <span class="stat-label">Retorno Total</span>
            <span class="stat-value ${results.totalReturn >= 0 ? 'text-success' : 'text-danger'}">${results.totalReturn}%</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Taxa de Acerto</span>
            <span class="stat-value">${winRate}%</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Total de Trades</span>
            <span class="stat-value">${results.trades.length}</span>
        </div>
        <div class="stat-card">
            <span class="stat-label">Ganhos / Perdas</span>
            <span class="stat-value text-success">${results.wins}</span> / 
            <span class="stat-value text-danger">${results.losses}</span>
        </div>
    `;

    document.getElementById('backtestStats').innerHTML = statsHTML;

    // Gr√°fico de equity
    const ctx = document.getElementById('backtestChart').getContext('2d');
    
    if (backtestChart) {
        backtestChart.destroy();
    }

    const labels = results.equity.map((_, i) => i);
    
    backtestChart = new Chart(ctx, {
        type: 'line',
         {
            labels: labels,
            datasets: [{
                label: 'Capital (‚Ç¨)',
                 results.equity,
                borderColor: results.totalReturn >= 0 ? '#10b981' : '#ef4444',
                backgroundColor: results.totalReturn >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    grid: { color: '#334155' },
                    ticks: { color: '#94a3b8' }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#94a3b8' }
                }
            }
        }
    });

    addAlert(`Backtest conclu√≠do: ${results.totalReturn}% em ${days} dias`, 
             results.totalReturn >= 0 ? 'buy' : 'sell');
}

function exportBacktest() {
    const data = {
        date: new Date().toISOString(),
        symbol: currentSymbol,
        timeframe: currentTimeframe,
        settings: settings,
        signals: signals
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backtest_${currentSymbol}_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    
    addAlert('Resultados exportados!', 'info');
}

// --- Utilit√°rios ---
function changeAsset() {
    currentSymbol = document.getElementById('assetSelect').value;
    document.getElementById('assetName').textContent = currentSymbol;
    
    if (ws) ws.close();
    priceData = [];
    connectWebSocket();
    loadHistoricalData();
    
    addAlert(`Ativo alterado para ${currentSymbol}`, 'info');
}

function changeTimeframe() {
    currentTimeframe = document.getElementById('timeframe').value;
    
    if (ws) ws.close();
    priceData = [];
    connectWebSocket();
    loadHistoricalData();
    
    addAlert(`Timeframe alterado para ${currentTimeframe}`, 'info');
}

function saveSettings() {
    settings.capital = parseFloat(document.getElementById('capital').value) || 10000;
    settings.riskPercent = parseFloat(document.getElementById('riskPercent').value) || 1;
    settings.rsiPeriod = parseInt(document.getElementById('rsiPeriod').value) || 14;
    settings.notifications = document.getElementById('notifications').value;
    
    localStorage.setItem('tradingSettings', JSON.stringify(settings));
}

function loadSettings() {
    const saved = localStorage.getItem('tradingSettings');
    if (saved) {
        settings = JSON.parse(saved);
        document.getElementById('capital').value = settings.capital;
        document.getElementById('riskPercent').value = settings.riskPercent;
        document.getElementById('rsiPeriod').value = settings.rsiPeriod;
        document.getElementById('notifications').value = settings.notifications;
    }
}

// Auto-save settings periodicamente
setInterval(saveSettings, 30000);
</script>

</body>
</html>